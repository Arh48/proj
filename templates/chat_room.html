{% extends "layout.html" %}

{% block title %}
    Chat Room
{% endblock %}

{% block main %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Group Code: {{ key }}</h3>
        <form id="deleteChatForm" action="/delete_chat/{{ key }}" method="POST" class="mb-0">
            <button type="submit" class="btn btn-danger">Delete Chat</button>
        </form>
    </div>

    <div class="chat-window mt-4">
        <div id="messages" class="message-box border rounded p-3" style="min-height: 300px; max-height: 500px; overflow-y: auto;">
            <!-- Messages will be dynamically populated -->
        </div>

        <form id="sendMessageForm" class="mt-3 d-flex" method="POST">
            <input type="text" name="message" id="messageInput" class="form-control" placeholder="Type your message" autocomplete="off">
            <button class="btn btn-primary ml-2" type="submit">Send</button>
        </form>
    </div>
</div>

<style>
    /* General message container styling */
    .message-box {
        display: flex;
        flex-direction: column;
        gap: 10px;
        height: 300px;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 15px;
        border-radius: 10px;
        background-color: #fff; /* Default light mode background */
    }

    /* General message styling for each bubble */
    .message {
        max-width: 60%;
        padding: 10px;
        border-radius: 15px;
        word-wrap: break-word;
        margin-bottom: 10px;
        font-size: 16px;
        display: inline-block;
    }

    /* Sent messages (current user) */
    .sent {
        background-color: #007bff;
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 0px;
    }

    /* Received messages (other users) */
    .received {
        background-color: #f1f1f1;
        color: black;
        align-self: flex-start;
        border-bottom-left-radius: 0px;
    }
</style>

<script>
    const key = "{{ key }}";
    const messagesContainer = document.getElementById('messages');
    const currentUser = "{{ current_user.username }}"; // Fetch the current user from Flask

    async function fetchMessages() {
        try {
            const response = await fetch(`/messages/${key}`);
            const data = await response.json();

            if (response.ok && data.messages) {
                updateMessages(data.messages);
            } else {
                console.error("Error fetching messages:", data.error || response.status);
            }
        } catch (error) {
            console.error("Fetch error:", error);
        }
    }

    function updateMessages(messages) {
        messagesContainer.innerHTML = ''; // Clear the messages container first
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            const isCurrentUser = message.username === currentUser;

            messageElement.classList.add('message', isCurrentUser ? 'sent' : 'received');
            messageElement.innerHTML = `<span class="username">${message.username} ${message.emoji}</span>: <span class="text">${message.message}</span>`;
            messagesContainer.appendChild(messageElement);
        });

        // Auto-scroll to the bottom after updating messages
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    setInterval(fetchMessages, 3000); // Fetch messages every 3 seconds

    const messageForm = document.getElementById('sendMessageForm');
    const messageInput = document.getElementById('messageInput');

    messageForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const messageText = messageInput.value;

        if (messageText.trim() === '') {
            return; // Prevent empty messages from being sent
        }

        try {
            const response = await fetch(`/chat_room/${key}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: messageText })
            });

            if (response.ok) {
                messageInput.value = ''; // Clear input after sending
                fetchMessages(); // Fetch latest messages right after sending one
            } else {
                const data = await response.json();
                console.error("Error sending message:", data.error || response.status);
            }
        } catch (error) {
            console.error("Fetch error:", error);
        }
    });
</script>

{% endblock %}
