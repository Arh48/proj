{% extends "layout.html" %}
{% block title %}Chat Room{% endblock %}

{% block main %}
<div class="container chat-container">
    <div class="d-flex justify-content-between align-items-center" style="padding: 1rem;">
        <h3 class="mb-0">Group Code: {{ key }}</h3>
    </div>
    <div class="chat-window" style="position: relative; flex: 1 1 0; display: flex; flex-direction: column; min-height: 0;">
        <div id="messages" class="message-box border rounded p-3"></div>
        <button id="newMessageIndicator" title="New messages below"
            style="display:none; position: absolute; right: -52px; bottom: 24px; z-index: 10; background: transparent; border: none; box-shadow: none;">
            <span class="fs-2 text-danger">
                <i class="bi bi-exclamation-circle-fill"></i>
            </span>
        </button>
        <div class="d-flex align-items-center mt-3" style="padding: 0.75rem;">
            <button type="button" class="btn btn-success plus-btn mr-2"
                title="Add Photo"
                onclick="document.getElementById('imageInput').click();"
                style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; font-size: 22px;">
                <span style="font-size:28px;line-height:0;">&#43;</span>
            </button>
            <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="uploadImage(event, '{{ key }}')">
            <form id="sendMessageForm" class="flex-grow-1 d-flex" method="POST">
                <input type="text" name="message" id="messageInput" class="form-control" placeholder="Type message" autocomplete="off">
                <button class="btn btn-primary ml-2" type="submit">Send</button>
            </form>
        </div>
    </div>
    <div id="fullscreenImageModal" style="display:none; position:fixed; z-index:20000; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); align-items:center; justify-content:center;">
        <img id="fullscreenImage" src="" alt="Full size" style="max-width:90vw; max-height:90vh; border-radius:16px; box-shadow:0 2px 32px #222;" />
        <button onclick="closeFullscreenImage()" style="position:absolute; top:32px; right:40px; font-size:2rem; background:transparent; border:none; color:white; z-index:20001;">&times;</button>
    </div>
</div>

<style>
html, body {
    height: 100%;
    width: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden; /* Prevent window (page) scrolling */
}

/* The navbar must have id="main-navbar" for this to work! */
.chat-container {
    height: calc(100vh - var(--navbar-height, 56px) - 16px);
    display: flex;
    flex-direction: column;
    padding: 0;
    margin: 0;
    max-width: 100vw;
    padding-left: 10px; 
    padding-right: 10px;
}

.chat-window {
    flex: 1 1 0;
    display: flex;
    flex-direction: column;
    min-height: 0;
    height: 100%;
    margin-top: 0;
    margin-bottom: 0;
}

.message-box {
    flex: 1 1 0;
    min-height: 0;
    overflow-y: auto;
    border: 1px solid #ccc;
    padding: 15px;
    border-radius: 10px;
    background: #23272a;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.d-flex.align-items-center.mt-3 {
    margin-top: 0 !important;
    padding-top: 8px;
    padding-bottom: 8px;
}

.discord-message {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 7px;
    padding-right: 10px;
}
.discord-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    background: #2f3136;
    border: 2px solid #23272A;
    margin-top: 1px;
}
.discord-bubble {
    flex: 1 1 0;
    display: flex;
    flex-direction: column;
}
.discord-header {
    display: flex;
    align-items: baseline;
    gap: 7px;
}
.discord-username {
    font-weight: 700;
    color: #4EF2F7;
    font-size: 16px;
    margin-right: 4px;
}
.discord-you {
    color: #b9bbbe;
    font-size: 16px;
    font-weight: 400;
    margin-right: 4px;
    font-style: normal;
}
.discord-timestamp {
    color: #b9bbbe;
    font-size: 13px;
    font-weight: 400;
    margin-top: 2px;
}
.discord-content {
    color: #dcddde;
    font-size: 15px;
    margin-top: 2px;
    word-break: break-word;
}
.discord-message.sent .discord-username {
    color: #f7b24e;
}
.discord-message.sent {
    outline: none !important;
    box-shadow: none !important;
}
.chat-image {
    max-width: 280px;
    max-height: 220px;
    border-radius: 10px;
    margin: 5px 0;
    display: block;
    cursor: pointer;
    transition: box-shadow .25s;
}
.chat-image:hover {
    box-shadow: 0 4px 24px #2225;
}
button:focus,
input:focus,
textarea:focus,
select:focus {
    outline: none !important;
    box-shadow: none !important;
}

@media (max-width: 600px) {
    .chat-container {
        padding: 0 !important;
    }
    .message-box {
        padding: 6px;
    }
}
</style>

<script>
// Dynamically set --navbar-height so chat always fits above any navbar, regardless of device
function setChatHeight() {
    const navbar = document.getElementById('main-navbar');
    if (navbar) {
        const navbarHeight = navbar.offsetHeight;
        document.documentElement.style.setProperty('--navbar-height', navbarHeight + 'px');
    }
}
window.addEventListener('resize', setChatHeight);
window.addEventListener('DOMContentLoaded', setChatHeight);

const key = "{{ key }}";
const messagesContainer = document.getElementById('messages');
const newMessageIndicator = document.getElementById('newMessageIndicator');
const currentUser = "{{ current_user.username }}";
let renderedMessageIds = new Set();

function getMessageId(message) {
    return message.id || message._id || JSON.stringify(message);
}

function isAtBottom() {
    const threshold = 40;
    return messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < threshold;
}

function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function notifyUser(message) {
    if (!("Notification" in window)) return;
    if (Notification.permission === "granted") {
        new Notification("New message from " + message.username, {
            body: message.message || "Sent an image",
            icon: "/static/favicon.ico"
        });
    }
}

// Returns true if the message is less than 60 seconds old (in UTC)
function isMessageRecent(utcTimestamp) {
    try {
        const messageDate = new Date(utcTimestamp);
        const nowUTC = new Date();
        // Both in ms, so difference in seconds
        const diffSeconds = (nowUTC - messageDate) / 1000;
        return diffSeconds >= 0 && diffSeconds < 60;
    } catch {
        return false;
    }
}

function appendNewMessages(messages, forceScrollBottom = false) {
    const atBottom = isAtBottom();
    const previousScrollHeight = messagesContainer.scrollHeight;
    let appended = false;

    messages.forEach(message => {
        const msgId = getMessageId(message);
        if (!renderedMessageIds.has(msgId)) {
            renderedMessageIds.add(msgId);
            appended = true;

            const isSent = message.username === currentUser;
            const profilePic = message.profile_pic ? `/static/profile_pics/${message.profile_pic}` : '/static/profile_pics/default.png';

            // --- Discord style message row ---
            const messageRow = document.createElement('div');
            messageRow.classList.add('discord-message');
            if (isSent) messageRow.classList.add('sent');

            // Avatar
            const avatar = document.createElement('img');
            avatar.className = "discord-avatar";
            avatar.src = profilePic;
            avatar.alt = "avatar";
            avatar.onerror = function(){ this.onerror=null; this.src='/static/profile_pics/default.png'; }

            // Message content
            const bubble = document.createElement('div');
            bubble.className = "discord-bubble";
            // Header: Username, (You), Timestamp
            const header = document.createElement('div');
            header.className = "discord-header";
            const username = document.createElement('span');
            username.className = "discord-username";
            username.textContent = message.username;
            header.appendChild(username);

            if (isSent) {
                const youSpan = document.createElement('span');
                youSpan.className = "discord-you";
                youSpan.textContent = "(You)";
                header.appendChild(youSpan);
            }

            const timestamp = document.createElement('span');
            timestamp.className = "discord-timestamp";
            timestamp.textContent = formatAEDTTime(message.timestamp);
            header.appendChild(timestamp);

            // Content
            const content = document.createElement('div');
            content.className = "discord-content";
            if (message.image_url) {
                content.innerHTML = `<img src="${message.image_url}" class="chat-image" alt="sent image" onclick="showFullscreenImage('${message.image_url.replace(/'/g, "\\'")}')">`;
            }
            if (message.message) {
                if (message.image_url) content.innerHTML += "<br>";
                content.innerHTML += message.message;
            }

            bubble.appendChild(header);
            bubble.appendChild(content);

            messageRow.appendChild(avatar);
            messageRow.appendChild(bubble);

            messagesContainer.appendChild(messageRow);

            // Notifications: only for new messages from others, if enabled, and if message is < 1 min old
            if (
                message.username !== currentUser &&
                document.cookie.includes("notifications_enabled=1") &&
                isMessageRecent(message.timestamp)
            ) {
                if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(function (permission) {
                        if (permission === "granted") {
                            notifyUser(message);
                        }
                    });
                } else if (Notification.permission === "granted") {
                    notifyUser(message);
                }
            }
        }
    });

    if (appended && !atBottom && !forceScrollBottom) {
        newMessageIndicator.style.display = 'block';
    }

    if (forceScrollBottom || (atBottom && appended)) {
        scrollToBottom();
        newMessageIndicator.style.display = 'none';
    } else if (appended) {
        const newScrollHeight = messagesContainer.scrollHeight;
        messagesContainer.scrollTop += (newScrollHeight - previousScrollHeight);
    }
}

// Convert UTC to AEDT (Australian Eastern Daylight Time, UTC+11)
function formatAEDTTime(utcTimestamp) {
    // The input is an ISO string or UTC timestamp.
    const utcDate = new Date(utcTimestamp);

    // AEDT is UTC+11, so add 11 hours in milliseconds.
    const AEDT_OFFSET = 10 * 60 * 60 * 1000;
    const aedtDate = new Date(utcDate.getTime() + AEDT_OFFSET);

    // Format: show "Today at 6:16:25 PM AEDT" if today, else "YYYY-MM-DD HH:mm:ss AEDT"
    const nowAEDT = new Date(Date.now() + AEDT_OFFSET);

    let timeString = aedtDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit', hour12: true});
    if (
        aedtDate.getDate() === nowAEDT.getDate() &&
        aedtDate.getMonth() === nowAEDT.getMonth() &&
        aedtDate.getFullYear() === nowAEDT.getFullYear()
    ) {
        return `Today at ${timeString} AEDT`;
    }
    const dateString = aedtDate.toLocaleDateString();
    return `${dateString} ${timeString} AEDT`;
}

function clearMessages() {
    messagesContainer.innerHTML = '';
    renderedMessageIds = new Set();
}

function fetchMessages(forceScrollBottom = false) {
    fetch(`/messages/${key}`)
        .then(response => response.json())
        .then(data => {
            if (data.messages) {
                appendNewMessages(data.messages, forceScrollBottom);
            }
        });
}

clearMessages();
setInterval(fetchMessages, 3000);

document.getElementById('sendMessageForm').addEventListener('submit', async (event) => {
    event.preventDefault();
    const messageInput = document.getElementById('messageInput');
    if (messageInput.value.trim() === '') return;
    try {
        const response = await fetch(`/chat_room/${key}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: messageInput.value })
        });

        if (response.ok) {
            messageInput.value = '';
            fetchMessages(true);
        } else {
            const data = await response.json();
            console.error("Error sending message:", data.error || response.status);
        }
    } catch (error) {
        console.error("Fetch error:", error);
    }
});

function uploadImage(event, groupCode) {
    const file = event.target.files[0];
    if (!file) return;
    const formData = new FormData();
    formData.append('image', file);

    fetch(`/IMAGES/${groupCode}/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data && data.image_url) {
            fetch(`/chat_room/${groupCode}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: '',
                    image_url: data.image_url
                })
            }).then(() => {
                fetchMessages(true);
            });
        } else {
            alert('Photo upload failed.');
        }
    })
    .catch(error => {
        alert('Photo upload failed.');
    });
    event.target.value = "";
}

newMessageIndicator.addEventListener('click', function() {
    scrollToBottom();
    this.style.display = 'none';
});

messagesContainer.addEventListener('scroll', function() {
    if (isAtBottom()) {
        newMessageIndicator.style.display = 'none';
    }
});

function showFullscreenImage(src) {
    const modal = document.getElementById('fullscreenImageModal');
    const img = document.getElementById('fullscreenImage');
    img.src = src;
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}
function closeFullscreenImage() {
    document.getElementById('fullscreenImageModal').style.display = 'none';
    document.body.style.overflow = '';
}
document.getElementById('fullscreenImageModal').addEventListener('click', function(e) {
    if (e.target === this) closeFullscreenImage();
});

function checkTimeout() {
    fetch("/check_timeout")
        .then(response => response.json())
        .then(data => {
            if (data.timed_out) {
                window.location.href = "/chat";
            }
        })
        .catch(error => console.error("Error checking timeout:", error));
}

setInterval(checkTimeout, 3000);

document.addEventListener('DOMContentLoaded', function () {
    if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
        Notification.requestPermission();
    }
});
</script>
{% endblock %}